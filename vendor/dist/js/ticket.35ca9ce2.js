(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["ticket"],{"24dc":function(t,e,s){"use strict";s("b8b1")},"4ad9":function(t,e,s){},"8fc2":function(t,e,s){"use strict";s.r(e);var i=function(){var t=this,e=t._self._c;return e("div",{staticClass:"contentpanel ticket-page"},[e("div",{ref:"pageHeader",staticClass:"pagetitle"},[e("div",{staticClass:"left"},[e("div",{staticClass:"title"},[e("i",{staticClass:"iconfont icon-support"}),e("h2",[t._v(t._s(t.$t("ticket.support")))])])]),e("div",{staticClass:"right"},[e("el-button",{attrs:{type:"primary",icon:"el-icon-plus",size:"small"},on:{click:t.openAddComment}},[t._v(t._s(t.$t("ticket.createTicket")))])],1)]),e("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"pagebody"},[e("el-row",{staticClass:"mg-b-20",attrs:{gutter:15}},[e("el-col",{attrs:{span:24}},[t.items.length?t._e():e("el-card",{staticClass:"text-center"},[t._v(t._s(t.$t("ticket.nodata")))]),e("el-card",{directives:[{name:"show",rawName:"v-show",value:t.items.length,expression:"items.length"}],staticClass:"chat-card"},[e("div",{ref:"chatCard",staticClass:"chat-box"},[e("div",{staticClass:"left"},[e("div",{staticClass:"t-list"},[e("el-scrollbar",{ref:"leftScroll",staticStyle:{height:"100%"}},[e("div",t._l(t.items,(function(s){return e("div",{key:s.id,staticClass:"t-card",class:{active:t.msgId==s.id},on:{click:function(e){return e.stopPropagation(),t.viewDetail(s,e)}}},[2==s.userRead?e("div",{staticClass:"user-read"}):t._e(),e("div",{staticClass:"row1 tx-ellipsis1"},[t._v(t._s(s.contents))]),e("div",{staticClass:"row2 tx-ellipsis1"},[t._v(t._s(s.shopName))]),e("div",{staticClass:"img-list"},t._l(s.attach,(function(t){return e("el-image",{key:t,staticStyle:{width:"40px",height:"40px"},attrs:{src:t,"preview-src-list":s.attach}})})),1),e("div",{staticClass:"row3"},[e("div"),e("div",{staticClass:"time"},[t._v(t._s(t.$moment.unix(s.timeLastUpdate).format("YYYY-MM-DD HH:mm:ss")))])])])})),0)])],1)]),t.items.length?e("div",{directives:[{name:"loading",rawName:"v-loading",value:t.msgLoading,expression:"msgLoading"}],staticClass:"right"},[t.activeItem?e("div",{staticClass:"header"},[t.activeItem.contents?e("div",{staticClass:"row-1"},[e("span",{staticClass:"title"},[t._v(t._s(t.$t("ticket.issue"))+":")]),e("span",{staticClass:"text"},[t._v(t._s(t.activeItem.contents))])]):t._e(),t.activeItem.attach&&t.activeItem.attach.length?e("div",{staticClass:"row-1"},[e("span",{staticClass:"title"},[t._v(t._s(t.$t("ticket.relatedImages"))+":")]),e("div",{staticClass:"text"},t._l(t.activeItem.attach,(function(s){return e("el-image",{key:s,staticStyle:{width:"40px",height:"40px"},attrs:{src:s,"preview-src-list":t.activeItem.attach}})})),1)]):t._e()]):t._e(),e("div",{staticClass:"chat-list-box",attrs:{id:"chatListBox"}},[e("div",{staticClass:"chat-list"},[t.msgList.length?t._e():e("div",{staticClass:"no-msg"},[t._v(" "+t._s(t.$t("ticket.nodata"))+" ")]),t._l(t.msgList,(function(s){return e("div",{key:s.id,staticClass:"chat",class:{my:1==s.type}},[e("div",{staticClass:"chat-content"},[2==s.type?e("div",{staticClass:"user"}):t._e(),1==s.type?e("div",{staticClass:"user"},[t.$store.state.userInfo.name?e("i",{staticStyle:{"font-size":"16px","font-style":"normal"}},[t._v(" "+t._s(t.$store.state.userInfo.name.substr(0,1))+" ")]):e("i",{staticClass:"el-icon-user-solid"})]):t._e(),s.contents?e("div",{staticClass:"arrow"}):t._e(),s.contents?e("div",{staticClass:"text",domProps:{innerHTML:t._s(t.testHtpp(s))}}):t._e()]),e("div",{staticClass:"img-list",class:{pr35:!s.contents}},t._l(s.attach,(function(t){return e("el-image",{key:t,staticStyle:{width:"40px",height:"40px"},attrs:{src:t,fit:"contain","preview-src-list":s.attach}})})),1),e("div",{staticClass:"time",class:{pr35:!s.contents}},[t._v(t._s(t.$moment.unix(s.timeCreated).format("YYYY-MM-DD HH:mm:ss")))])])}))],2)]),e("div",{staticClass:"chat-bottom"},[e("div",{staticClass:"row1"},[t.bottomUploadLoading?e("a",{staticClass:"upload-img",attrs:{href:"javascript:;"}},[e("i",{staticClass:"el-icon-loading"})]):e("a",{staticClass:"upload-img",attrs:{href:"javascript:;"},on:{click:t.openBottomUpload}},[e("i",{staticClass:"el-icon-picture-outline"})]),e("div",{staticClass:"send-message"},[e("input",{directives:[{name:"model",rawName:"v-model",value:t.messageText,expression:"messageText"}],attrs:{type:"text",placeholder:t.$t("ticket.pleaseEnterContent")},domProps:{value:t.messageText},on:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.addMsg.apply(null,arguments)},input:function(e){e.target.composing||(t.messageText=e.target.value)}}})]),e("div",[e("el-button",{attrs:{type:"primary",loading:t.sendMsgLoading},on:{click:t.addMsg}},[t._v(t._s(t.$t("ticket.send")))])],1)]),e("div",{staticClass:"row2"},t._l(t.msgImg,(function(s,i){return e("div",{key:s,staticClass:"img-wrap"},[e("el-image",{staticStyle:{width:"40px",height:"40px"},attrs:{src:s,fit:"contain"}}),e("div",{staticClass:"mask"},[e("div",{staticClass:"img-del"},[e("a",{attrs:{href:"javascript:;"},on:{click:function(e){return t.removeImg(i,t.msgImg)}}},[e("i",{staticClass:"el-icon-delete"})])])])],1)})),0)])]):t._e()])])],1)],1)],1),e("el-dialog",{attrs:{title:"",visible:t.DialogEditComment.visible,width:"760px"},on:{"update:visible":function(e){return t.$set(t.DialogEditComment,"visible",e)},closed:function(e){return t.$refs.uploadFile.clearFiles()}}},[e("div",[e("el-form",{ref:"CommentForm"},[e("el-form-item",{attrs:{label:t.$t("ticket.problemsOrRequirements")}},[e("el-input",{attrs:{type:"textarea"},model:{value:t.DialogEditComment.contents,callback:function(e){t.$set(t.DialogEditComment,"contents",e)},expression:"DialogEditComment.contents"}})],1),e("el-row",{staticClass:"d-flex align-items-center mg-b-10",attrs:{gutter:15}},[e("el-col",{staticStyle:{"min-width":"155px"},attrs:{span:5}},[e("span",{staticStyle:{"font-size":"16px","font-weight":"bold"}},[t._v(t._s(t.$t("ticket.uploadImageAttachment")))])]),e("el-upload",{ref:"uploadFile",staticClass:"upload-file",attrs:{"on-change":t.handleChange,"before-remove":t.handleRemove,action:"","auto-upload":!1,accept:"image/gif,image/jpeg,image/jpg,image/png"}},[e("el-button",{ref:"uploadBtn",attrs:{size:"small",type:"primary",loading:t.DialogEditComment.uploadLoading}},[t._v(t._s(t.$t("ticket.browse")))])],1)],1)],1)],1),e("div",{staticClass:"dialog-footer d-flex justify-content-end",attrs:{slot:"footer"},slot:"footer"},[e("div",{staticClass:"mg-r-15"},[e("el-button",{attrs:{size:"small",type:"primary",loading:t.DialogEditComment.loading},on:{click:t.saveComment}},[t._v(t._s(t.$t("ticket.submitTicket")))])],1),e("div",[e("el-button",{attrs:{size:"small"},on:{click:function(e){t.DialogEditComment.visible=!1}}},[t._v(t._s(t.$t("ticket.discard")))])],1)])]),e("input",{staticStyle:{display:"none"},attrs:{id:"bottomUploadImg",type:"file",accept:"image/gif,image/jpeg,image/jpg,image/png"},on:{change:function(e){return t.bottomUploadimg(e)}}})],1)},a=[],o=(s("14d9"),{data(){return{tableHeight:400,loading:!1,pageSizes:[20,50,100],page:this.$route.query.page?Number(this.$route.query.page):1,rowsPerPage:localStorage.getItem("myTicketPage")?Number(localStorage.getItem("myTicketPage")):20,total:0,totalPage:0,items:[],DialogEditComment:{loading:!1,uploadLoading:!1,visible:!1,contents:"",shopName:"",attach:[],commentId:"",item:null},DialogEditCommentDefault:"{}",msgLoading:!1,msgId:"",msgList:[],messageText:"",bottomUpload:"",msgImg:[],sendMsgLoading:!1,bottomUploadLoading:!1}},computed:{activeItem(){let t=null;return this.msgId&&this.items.some(e=>{if(e.id==this.msgId)return t=e,!0}),t}},mounted(){this.setChatCardHeight(),this.DialogEditCommentDefault=JSON.stringify(this.DialogEditComment),this.getItem(!0),window.onresize=()=>{this.setChatCardHeight()};let t=this.$refs.leftScroll.wrap;t.onscroll=()=>{t.scrollTop+t.offsetHeight+200>t.scrollHeight&&this.totalPage>this.page&&(this.page++,this.getItem())}},beforeDestroy(){this.$refs.leftScroll.wrap.onscroll=()=>{},window.onresize=()=>{}},methods:{testHtpp(t){if(t.contents){var e=t.contents,s=/(https?.*?)(?=http|$|<|>|\s|,)/gi;return e=1==t.type?e.replace(s,"<a href='$1$2' target='_blank' style='color:#fff;'>$1$2</a>"):e.replace(s,"<a href='$1$2' target='_blank' style='color:#303133;'>$1$2</a>"),e}},removeImg(t,e){e.splice(t,1)},bottomUploadimg(t){this.bottomUploadLoading=!0,this.$apiCall("api.Comment.uploadAttach",{"@file":t.target.files[0]},t=>{this.bottomUploadLoading=!1,"9999"==t.ErrorCode?this.msgImg.push(t.Data.Results.url):this.$elementMessage(t.Message,"error")})},openBottomUpload(){document.getElementById("bottomUploadImg").click()},addMsg(){this.messageText||this.msgImg.length?(this.sendMsgLoading=!0,this.$apiCall("api.Comment.addByUser",{commentId:this.msgId,contents:this.messageText,attach:this.msgImg},t=>{this.sendMsgLoading=!1,"9999"==t.ErrorCode?(this.messageText="",this.msgImg=[],this.getItem(!0),this.viewDetail(this.activeItem),this.$refs.leftScroll.wrap.scrollTop=0):this.$elementMessage(t.Message,"error")})):this.$elementMessage(this.$t("ticket.contentCannotEmpty"),"error")},setChatCardHeight(){this.$refs.chatCard.style.height=document.body.clientHeight-190+"px"},handleRemove(t,e){e.forEach((e,s)=>{e.name==t.name&&this.DialogEditComment.attach.splice(s,1)})},handleChange(t){this.DialogEditComment.loading=!0,this.DialogEditComment.uploadLoading=!0,this.$apiCall("api.Comment.uploadAttach",{"@file":t.raw},t=>{this.DialogEditComment.loading=!1,this.DialogEditComment.uploadLoading=!1,"9999"==t.ErrorCode?this.DialogEditComment.attach.push(t.Data.Results.url):this.$elementMessage(t.Message,"error")})},viewDetail(t,e){e&&"img"==e.target.localName||(this.msgLoading=!0,this.$apiCall("api.Comment.getDetailByUser",{commentId:t.id},e=>{if(this.msgLoading=!1,"9999"==e.ErrorCode){this.$root.$children[0].getMsgNum(),this.$set(t,"userRead","1"),this.msgList=[],e.Data.Results.forEach(t=>{t.attach=JSON.parse(t.attach),this.msgList.unshift(t)}),this.msgId=t.id;let s=document.getElementById("chatListBox");s&&setTimeout(()=>{s.scroll(0,s.scrollHeight)},500)}else this.$elementMessage(e.Message,"error")}))},openAddComment(){this.$refs.uploadFile&&this.$refs.uploadFile.clearFiles(),this.DialogEditComment=JSON.parse(this.DialogEditCommentDefault),this.DialogEditComment.visible=!0},saveComment(){if(!this.DialogEditComment.contents)return this.$message({message:this.$t("ticket.issueCannotEmpty"),type:"error"}),!1;this.DialogEditComment.loading=!0,this.$apiCall("api.Comment.addByUser",{commentId:this.DialogEditComment.commentId,contents:this.DialogEditComment.contents,shopName:this.DialogEditComment.shopName,attach:this.DialogEditComment.attach},t=>{this.DialogEditComment.loading=!1,9999==t.ErrorCode?(this.DialogEditComment.visible=!1,this.$message({message:this.$t("ticket.success"),type:"success"}),this.getItem(!0)):this.$message({message:t.Message,type:"error"})})},getItem(t){this.loading=!0,t&&(this.page=1),this.$apiCall("api.Comment.findByUser",{page:this.page,rowsPerPage:this.rowsPerPage},e=>{this.loading=!1,"9999"==e.ErrorCode?(t&&(this.items=[]),e.Data.Results.forEach(t=>{t.attach=JSON.parse(t.attach),this.items.push(t)}),this.total=Number(e.Data.Pagination.totalCount),this.totalPage=Number(e.Data.Pagination.totalPage),!this.activeItem&&1==this.page&&this.items.length&&this.viewDetail(this.items[0])):(this.$elementMessage(e.Message,"error"),"1002"!=e.ErrorCode&&"1003"!=e.ErrorCode||this.$userFailure())})}}}),l=o,n=(s("e66e"),s("24dc"),s("2877")),r=Object(n["a"])(l,i,a,!1,null,"435c0c8c",null);e["default"]=r.exports},b8b1:function(t,e,s){},e66e:function(t,e,s){"use strict";s("4ad9")}}]);