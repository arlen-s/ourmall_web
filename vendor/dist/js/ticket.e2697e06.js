(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["ticket"],{"031d":function(t,e,s){},"2d91":function(t,e,s){"use strict";s("031d")},"8fc2":function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"contentpanel ticket-page"},[s("div",{ref:"pageHeader",staticClass:"pagetitle"},[s("div",{staticClass:"left"},[s("div",{staticClass:"title"},[s("i",{staticClass:"iconfont icon-support"}),s("h2",[t._v(t._s(t.$t("ticket.support")))])])]),s("div",{staticClass:"right"},[s("el-button",{attrs:{type:"primary",icon:"el-icon-plus",size:"small"},on:{click:t.openAddComment}},[t._v(t._s(t.$t("ticket.createTicket")))])],1)]),s("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"pagebody"},[s("el-row",{staticClass:"mg-b-20",attrs:{gutter:15}},[s("el-col",{attrs:{span:24}},[t.items.length?t._e():s("el-card",{staticClass:"text-center"},[t._v(t._s(t.$t("ticket.nodata")))]),s("el-card",{directives:[{name:"show",rawName:"v-show",value:t.items.length,expression:"items.length"}],staticClass:"chat-card"},[s("div",{ref:"chatCard",staticClass:"chat-box"},[s("div",{staticClass:"left"},[s("div",{staticClass:"t-list"},[s("el-scrollbar",{ref:"leftScroll",staticStyle:{height:"100%"}},[s("div",t._l(t.items,(function(e){return s("div",{key:e.id,staticClass:"t-card",class:{active:t.msgId==e.id},on:{click:function(s){return s.stopPropagation(),t.viewDetail(e,s)}}},[2==e.userRead?s("div",{staticClass:"user-read"}):t._e(),s("div",{staticClass:"row1 tx-ellipsis1"},[t._v(t._s(e.contents))]),s("div",{staticClass:"row2 tx-ellipsis1"},[t._v(t._s(e.shopName))]),s("div",{staticClass:"img-list"},t._l(e.attach,(function(t){return s("el-image",{key:t,staticStyle:{width:"40px",height:"40px"},attrs:{src:t,"preview-src-list":e.attach}})})),1),s("div",{staticClass:"row3"},[s("div"),s("div",{staticClass:"time"},[t._v(t._s(t.$moment.unix(e.timeLastUpdate).format("YYYY-MM-DD HH:mm:ss")))])])])})),0)])],1)]),t.items.length?s("div",{directives:[{name:"loading",rawName:"v-loading",value:t.msgLoading,expression:"msgLoading"}],staticClass:"right"},[t.activeItem?s("div",{staticClass:"header"},[t.activeItem.contents?s("div",{staticClass:"row-1"},[s("span",{staticClass:"title"},[t._v(t._s(t.$t("ticket.issue"))+":")]),s("span",{staticClass:"text"},[t._v(t._s(t.activeItem.contents))])]):t._e(),t.activeItem.attach&&t.activeItem.attach.length?s("div",{staticClass:"row-1"},[s("span",{staticClass:"title"},[t._v(t._s(t.$t("ticket.relatedImages"))+":")]),s("div",{staticClass:"text"},t._l(t.activeItem.attach,(function(e){return s("el-image",{key:e,staticStyle:{width:"40px",height:"40px"},attrs:{src:e,"preview-src-list":t.activeItem.attach}})})),1)]):t._e()]):t._e(),s("div",{staticClass:"chat-list-box",attrs:{id:"chatListBox"}},[s("div",{staticClass:"chat-list"},[t.msgList.length?t._e():s("div",{staticClass:"no-msg"},[t._v(" "+t._s(t.$t("ticket.nodata"))+" ")]),t._l(t.msgList,(function(e){return s("div",{key:e.id,staticClass:"chat",class:{my:1==e.type}},[s("div",{staticClass:"chat-content"},[2==e.type?s("div",{staticClass:"user"}):t._e(),1==e.type?s("div",{staticClass:"user"},[t.$store.state.userInfo.name?s("i",{staticStyle:{"font-size":"16px","font-style":"normal"}},[t._v(" "+t._s(t.$store.state.userInfo.name.substr(0,1))+" ")]):s("i",{staticClass:"el-icon-user-solid"})]):t._e(),e.contents?s("div",{staticClass:"arrow"}):t._e(),e.contents?s("div",{staticClass:"text",domProps:{innerHTML:t._s(t.testHtpp(e))}}):t._e()]),s("div",{staticClass:"img-list",class:{pr35:!e.contents}},t._l(e.attach,(function(t){return s("el-image",{key:t,staticStyle:{width:"40px",height:"40px"},attrs:{src:t,fit:"contain","preview-src-list":e.attach}})})),1),s("div",{staticClass:"time",class:{pr35:!e.contents}},[t._v(t._s(t.$moment.unix(e.timeCreated).format("YYYY-MM-DD HH:mm:ss")))])])}))],2)]),s("div",{staticClass:"chat-bottom"},[s("div",{staticClass:"row1"},[t.bottomUploadLoading?s("a",{staticClass:"upload-img",attrs:{href:"javascript:;"}},[s("i",{staticClass:"el-icon-loading"})]):s("a",{staticClass:"upload-img",attrs:{href:"javascript:;"},on:{click:t.openBottomUpload}},[s("i",{staticClass:"el-icon-picture-outline"})]),s("div",{staticClass:"send-message"},[s("input",{directives:[{name:"model",rawName:"v-model",value:t.messageText,expression:"messageText"}],attrs:{type:"text",placeholder:t.$t("ticket.pleaseEnterContent")},domProps:{value:t.messageText},on:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.addMsg.apply(null,arguments)},input:function(e){e.target.composing||(t.messageText=e.target.value)}}})]),s("div",[s("el-button",{attrs:{type:"primary",loading:t.sendMsgLoading},on:{click:t.addMsg}},[t._v(t._s(t.$t("ticket.send")))])],1)]),s("div",{staticClass:"row2"},t._l(t.msgImg,(function(e,a){return s("div",{key:e,staticClass:"img-wrap"},[s("el-image",{staticStyle:{width:"40px",height:"40px"},attrs:{src:e,fit:"contain"}}),s("div",{staticClass:"mask"},[s("div",{staticClass:"img-del"},[s("a",{attrs:{href:"javascript:;"},on:{click:function(e){return t.removeImg(a,t.msgImg)}}},[s("i",{staticClass:"el-icon-delete"})])])])],1)})),0)])]):t._e()])])],1)],1)],1),s("el-dialog",{attrs:{title:"",visible:t.DialogEditComment.visible,width:"760px"},on:{"update:visible":function(e){return t.$set(t.DialogEditComment,"visible",e)},closed:function(e){return t.$refs.uploadFile.clearFiles()}}},[s("div",[s("el-form",{ref:"CommentForm"},[s("el-form-item",{attrs:{label:t.$t("ticket.problemsOrRequirements")}},[s("el-input",{attrs:{type:"textarea"},model:{value:t.DialogEditComment.contents,callback:function(e){t.$set(t.DialogEditComment,"contents",e)},expression:"DialogEditComment.contents"}})],1),s("el-row",{staticClass:"d-flex align-items-center mg-b-10",attrs:{gutter:15}},[s("el-col",{staticStyle:{"min-width":"155px"},attrs:{span:5}},[s("span",{staticStyle:{"font-size":"16px","font-weight":"bold"}},[t._v(t._s(t.$t("ticket.uploadImageAttachment")))])]),s("el-upload",{ref:"uploadFile",staticClass:"upload-file",attrs:{"on-change":t.handleChange,"before-remove":t.handleRemove,action:"","auto-upload":!1,accept:"image/gif,image/jpeg,image/jpg,image/png"}},[s("el-button",{ref:"uploadBtn",attrs:{size:"small",type:"primary",loading:t.DialogEditComment.uploadLoading}},[t._v(t._s(t.$t("ticket.browse")))])],1)],1)],1)],1),s("div",{staticClass:"dialog-footer d-flex justify-content-end",attrs:{slot:"footer"},slot:"footer"},[s("div",{staticClass:"mg-r-15"},[s("el-button",{attrs:{size:"small",type:"primary",loading:t.DialogEditComment.loading},on:{click:t.saveComment}},[t._v(t._s(t.$t("ticket.submitTicket")))])],1),s("div",[s("el-button",{attrs:{size:"small"},on:{click:function(e){t.DialogEditComment.visible=!1}}},[t._v(t._s(t.$t("ticket.discard")))])],1)])]),s("input",{staticStyle:{display:"none"},attrs:{id:"bottomUploadImg",type:"file",accept:"image/gif,image/jpeg,image/jpg,image/png"},on:{change:function(e){return t.bottomUploadimg(e)}}})],1)},i=[],o=(s("a9e3"),s("d3b7"),s("e9c4"),s("ac1f"),s("5319"),s("a434"),s("159b"),s("b0c0"),{data:function(){return{tableHeight:400,loading:!1,pageSizes:[20,50,100],page:this.$route.query.page?Number(this.$route.query.page):1,rowsPerPage:localStorage.getItem("myTicketPage")?Number(localStorage.getItem("myTicketPage")):20,total:0,totalPage:0,items:[],DialogEditComment:{loading:!1,uploadLoading:!1,visible:!1,contents:"",shopName:"",attach:[],commentId:"",item:null},DialogEditCommentDefault:"{}",msgLoading:!1,msgId:"",msgList:[],messageText:"",bottomUpload:"",msgImg:[],sendMsgLoading:!1,bottomUploadLoading:!1}},computed:{activeItem:function(){var t=this,e=null;return this.msgId&&this.items.some((function(s){if(s.id==t.msgId)return e=s,!0})),e}},mounted:function(){var t=this;this.setChatCardHeight(),this.DialogEditCommentDefault=JSON.stringify(this.DialogEditComment),this.getItem(!0),window.onresize=function(){t.setChatCardHeight()};var e=this.$refs.leftScroll.wrap;e.onscroll=function(){e.scrollTop+e.offsetHeight+200>e.scrollHeight&&t.totalPage>t.page&&(t.page++,t.getItem())}},beforeDestroy:function(){this.$refs.leftScroll.wrap.onscroll=function(){},window.onresize=function(){}},methods:{testHtpp:function(t){if(t.contents){var e=t.contents,s=/(https?.*?)(?=http|$|<|>|\s|,)/gi;return e=1==t.type?e.replace(s,"<a href='$1$2' target='_blank' style='color:#fff;'>$1$2</a>"):e.replace(s,"<a href='$1$2' target='_blank' style='color:#303133;'>$1$2</a>"),e}},removeImg:function(t,e){e.splice(t,1)},bottomUploadimg:function(t){var e=this;this.bottomUploadLoading=!0,this.$apiCall("api.Comment.uploadAttach",{"@file":t.target.files[0]},(function(t){e.bottomUploadLoading=!1,"9999"==t.ErrorCode?e.msgImg.push(t.Data.Results.url):e.$elementMessage(t.Message,"error")}))},openBottomUpload:function(){document.getElementById("bottomUploadImg").click()},addMsg:function(){var t=this;this.messageText||this.msgImg.length?(this.sendMsgLoading=!0,this.$apiCall("api.Comment.addByUser",{commentId:this.msgId,contents:this.messageText,attach:this.msgImg},(function(e){t.sendMsgLoading=!1,"9999"==e.ErrorCode?(t.messageText="",t.msgImg=[],t.getItem(!0),t.viewDetail(t.activeItem),t.$refs.leftScroll.wrap.scrollTop=0):t.$elementMessage(e.Message,"error")}))):this.$elementMessage(this.$t("ticket.contentCannotEmpty"),"error")},setChatCardHeight:function(){this.$refs.chatCard.style.height=document.body.clientHeight-190+"px"},handleRemove:function(t,e){var s=this;e.forEach((function(e,a){e.name==t.name&&s.DialogEditComment.attach.splice(a,1)}))},handleChange:function(t){var e=this;this.DialogEditComment.loading=!0,this.DialogEditComment.uploadLoading=!0,this.$apiCall("api.Comment.uploadAttach",{"@file":t.raw},(function(t){e.DialogEditComment.loading=!1,e.DialogEditComment.uploadLoading=!1,"9999"==t.ErrorCode?e.DialogEditComment.attach.push(t.Data.Results.url):e.$elementMessage(t.Message,"error")}))},viewDetail:function(t,e){var s=this;e&&"img"==e.target.localName||(this.msgLoading=!0,this.$apiCall("api.Comment.getDetailByUser",{commentId:t.id},(function(e){if(s.msgLoading=!1,"9999"==e.ErrorCode){s.$root.$children[0].getMsgNum(),s.$set(t,"userRead","1"),s.msgList=[],e.Data.Results.forEach((function(t){t.attach=JSON.parse(t.attach),s.msgList.unshift(t)})),s.msgId=t.id;var a=document.getElementById("chatListBox");a&&setTimeout((function(){a.scroll(0,a.scrollHeight)}),500)}else s.$elementMessage(e.Message,"error")})))},openAddComment:function(){this.$refs.uploadFile&&this.$refs.uploadFile.clearFiles(),this.DialogEditComment=JSON.parse(this.DialogEditCommentDefault),this.DialogEditComment.visible=!0},saveComment:function(){var t=this;if(!this.DialogEditComment.contents)return this.$message({message:this.$t("ticket.issueCannotEmpty"),type:"error"}),!1;this.DialogEditComment.loading=!0,this.$apiCall("api.Comment.addByUser",{commentId:this.DialogEditComment.commentId,contents:this.DialogEditComment.contents,shopName:this.DialogEditComment.shopName,attach:this.DialogEditComment.attach},(function(e){t.DialogEditComment.loading=!1,9999==e.ErrorCode?(t.DialogEditComment.visible=!1,t.$message({message:t.$t("ticket.success"),type:"success"}),t.getItem(!0)):t.$message({message:e.Message,type:"error"})}))},getItem:function(t){var e=this;this.loading=!0,t&&(this.page=1),this.$apiCall("api.Comment.findByUser",{page:this.page,rowsPerPage:this.rowsPerPage},(function(s){e.loading=!1,"9999"==s.ErrorCode?(t&&(e.items=[]),s.Data.Results.forEach((function(t){t.attach=JSON.parse(t.attach),e.items.push(t)})),e.total=Number(s.Data.Pagination.totalCount),e.totalPage=Number(s.Data.Pagination.totalPage),!e.activeItem&&1==e.page&&e.items.length&&e.viewDetail(e.items[0])):(e.$elementMessage(s.Message,"error"),"1002"!=s.ErrorCode&&"1003"!=s.ErrorCode||e.$userFailure())}))}}}),n=o,l=(s("e970"),s("2d91"),s("2877")),c=Object(l["a"])(n,a,i,!1,null,"435c0c8c",null);e["default"]=c.exports},"94d5":function(t,e,s){},e970:function(t,e,s){"use strict";s("94d5")}}]);